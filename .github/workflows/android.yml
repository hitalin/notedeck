name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: pnpm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          sdkmanager "platforms;android-36" "build-tools;35.0.0" "build-tools;36.0.0" "ndk;27.0.12077973"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: pnpm install

      - name: Lint (Biome)
        run: pnpm biome check

      - name: Type check
        run: pnpm vue-tsc --noEmit

      - name: Test
        run: pnpm vitest run

      - name: Init Android project
        run: npx tauri android init

      - name: Build APK
        run: npx tauri android build --apk
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.12077973

      - name: Sign APK
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > /tmp/release.keystore
          BUILD_TOOLS="${ANDROID_HOME}/build-tools/36.0.0"
          APK="src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk"
          ALIGNED="${APK%.apk}-aligned.apk"
          SIGNED="${APK/unsigned/signed}"

          "$BUILD_TOOLS/zipalign" -v -p 4 "$APK" "$ALIGNED"
          "$BUILD_TOOLS/apksigner" sign \
            --ks /tmp/release.keystore \
            --ks-pass "pass:${ANDROID_KEYSTORE_PASSWORD}" \
            --ks-key-alias "${ANDROID_KEY_ALIAS}" \
            --key-pass "pass:${ANDROID_KEY_PASSWORD}" \
            --out "$SIGNED" "$ALIGNED"
          "$BUILD_TOOLS/apksigner" verify "$SIGNED"

          rm /tmp/release.keystore

      - name: Get version
        if: startsWith(github.ref, 'refs/tags/v')
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Rename APK
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          SIGNED="src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk"
          UNSIGNED="src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk"
          if [ -f "$SIGNED" ]; then
            cp "$SIGNED" "NoteDeck-${{ steps.version.outputs.version }}-android.apk"
          else
            cp "$UNSIGNED" "NoteDeck-${{ steps.version.outputs.version }}-android.apk"
          fi

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: NoteDeck-*-android.apk

      - name: Upload APK artifact
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: src-tauri/gen/android/app/build/outputs/apk/
